<form id="form" class="max-w-sm mx-auto" onsubmit="return validateForm(event)">
	<h3 data-i18n="heading" class="text-center text-yellow-400/80 text-lg font-extrabold py-4 "></h3>
	<div class="field mb-5 flow-root ">
	<label for="nombre" data-i18n="labelName" class="block mb-2 text-base font-medium text-gray-300"></label>
	  <div class="field relative"> 
	  <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none">
		<svg  class="w-4 h-4 text-gray-500 dark:text-gray-400" xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-users">
		<path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 7m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0" /><path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /><path d="M21 21v-2a4 4 0 0 0 -3 -3.85" /></svg>
		</div>
	<input type="text" name="nombre" id="nombre" data-placeholder-key="placeholderName" class="bg-blue-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full ps-10 p-2.5" placeholder="Ingresa tu nombre">
	</div>
	<!-- Honeypot (hidden from users) to catch bots that fill all fields -->
	<input type="text" name="hp_name" id="hp_name" autocomplete="off" tabindex="-1" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;">
	<!-- Timestamp when page loaded; validate min time on submit -->
	<input type="hidden" name="form_timestamp" id="form_timestamp" value="">
	</div>
	<div class="field mb-5 flow-root ">
	<label for="subject" data-i18n="labelSubject" class="block mb-2 text-base font-medium text-gray-300"></label>
	  	<div class="field relative">
			<div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none">
			<svg class="w-4 h-4 text-gray-500 dark:text-gray-400" xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-droplet-question"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18.064 10.877l-4.89 -7.26c-.42 -.625 -1.287 -.803 -1.936 -.397a1.376 1.376 0 0 0 -.41 .397l-4.893 7.26c-1.695 2.838 -1.035 6.441 1.567 8.546c2.203 1.782 5.259 2.056 7.723 .82" /><path d="M19 22v.01" /><path d="M19 19a2.003 2.003 0 0 0 .914 -3.782a1.98 1.98 0 0 0 -2.414 .483" /></svg>
			</div>
			<input type="text" name="subject" id="subject" data-placeholder-key="placeholderSubject" class="bg-gray-50 border border-gray-300 text-gray-900 text-base rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full ps-10 p-2.5" placeholder="Asunto">
		</div>
	</div>
	<div class="field mb-5 flow-root ">
	<label for="email" data-i18n="labelEmail" class="block mb-2 text-base font-medium text-gray-300"></label>
	  <div class="field relative">
    	<div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none">
      		<svg class="w-4 h-4 text-gray-500 dark:text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 16">
    		<path d="m10.036 8.278 9.258-7.79A1.979 1.979 0 0 0 18 0H2A1.987 1.987 0 0 0 .641.541l9.395 7.737Z"/>
    		<path d="M11.241 9.817c-.36.275-.801.425-1.255.427-.428 0-.845-.138-1.187-.395L0 2.6V14a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V2.5l-8.759 7.317Z"/>
      		</svg>
    	</div>
	<input type="email" name="email" id="email" data-placeholder-key="placeholderEmail" class="mb-2 bg-gray-50 border border-gray-300 text-gray-900 text-base rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full ps-10 p-2.5" placeholder="nombre@email.com">
	</div>
	<div class="field mb-5 flow-root ">
	<label for="telefono" data-i18n="labelPhone" class="block mb-2 text-base font-medium text-gray-300"></label>
	  <div class="field relative">
    	<div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none">
      		<svg class="w-4 h-4 text-gray-500 dark:text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.95.684l1.518 4.554a1 1 0 01-.217.976l-2.1 2.1a11.042 11.042 0 005.516 5.516l2.1-2.1a1 1 0 01.976-.217l4.554 1.518A1 1 0 0121 17.72V21a2 2 0 01-2 2h-1C9.163 23 1 14.837 1 5V4a2 2 0 012-2z" /></svg>
    	</div>
	<input type="tel" name="telefono" id="telefono" data-placeholder-key="placeholderPhone" class="mb-2 bg-gray-50 border border-gray-300 text-gray-900 text-base rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full ps-10 p-2.5" placeholder="Ej: +56912345678" pattern="^\+?\d{8,15}$">
	</div>
	</div>
	<div class="field mb-5 flow-root ">
	<label for="coments" data-i18n="labelComment" class="block mb-2 text-base font-medium text-gray-300"></label>
	  <div class="field relative">
	  <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none">
	  <svg class="w-6 h-6 text-gray-500 dark:text-gray-400" xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-bubble-text"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 10h10" /><path d="M9 14h5" /><path d="M12.4 3a5.34 5.34 0 0 1 4.906 3.239a5.333 5.333 0 0 1 -1.195 10.6a4.26 4.26 0 0 1 -5.28 1.863l-3.831 2.298v-3.134a2.668 2.668 0 0 1 -1.795 -3.773a4.8 4.8 0 0 1 2.908 -8.933a5.33 5.33 0 0 1 4.287 -2.16" /></svg>
	</div>
	<textarea name="coments" id="coments" data-placeholder-key="placeholderComment" class="ps-10 text-sm block w-full p-4 text-gray-900 border border-gray-300 rounded-lg  bg-gray-50  focus:ring-blue-500 focus:border-blue-500 placeholder-gray-400 " placeholder="Deja un Comentario" required></textarea>
	</div>
	</div>
	<div id="form-error" data-i18n="errorInvalid" class="text-red-500 text-center mb-2 hidden"></div>
	<div class="field mb-5 py-6 content-center place-items-center gap-1 mx-1 flex flex-wrap justify-center ">
	<input type="submit" id="button" value="E" class="py-3 mb-3  text-white items-center bg-orange-700/80 hover:bg-yellow-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm w-full sm:w-auto px-5 text-center">
	</div>  
</form>




<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script type="text/javascript">
	(function(){
		// initialize EmailJS SDK with public key
		try { emailjs.init({ publicKey: 'tK8UViD9d3Md7C_7T' }); } catch(e) { console.warn('emailjs.init failed', e); }
	})();
</script>
<script src="../components/EmailJs.js"></script>

<script type="text/javascript" is:inline>
// Translation map (EN/ES) — añadimos mensajes de error nuevos
const T = {
	es: {
		heading: 'Envíame un correo',
		labelName: 'Nombre',
		labelSubject: 'Asunto',
		labelEmail: 'Tu Email',
		labelPhone: 'Teléfono',
		labelComment: 'Comentario',
		placeholderName: 'Ingresa tu nombre',
		placeholderSubject: 'Asunto',
		placeholderEmail: 'nombre@email.com',
		placeholderPhone: 'Ej: +56912345678',
		placeholderComment: 'Deja un Comentario',
		errorInvalid: 'Debes ingresar un email válido o un número de teléfono válido.',
		errorRequired: 'El campo Comentario es obligatorio.',
		errorDisposable: 'No se aceptan correos desde dominios desechables.',
		errorHoneypot: 'Detectado envío automatizado (honeypot).',
		errorTooFast: 'Formulario enviado demasiado rápido; espera unos segundos antes de enviar.',
		errorSpam: 'El mensaje parece spam o incomprensible. Por favor escribe un comentario claro.',
		errorRateLimit: 'Has enviado muchos mensajes. Intenta de nuevo más tarde.',
		send: 'Enviar',
		sending: 'Enviando...',
		sent: 'Enviado'
	},
	en: {
		heading: 'Send me an email',
		labelName: 'Name',
		labelSubject: 'Subject',
		labelEmail: 'Your Email',
		labelPhone: 'Phone',
		labelComment: 'Comment',
		placeholderName: 'Enter your name',
		placeholderSubject: 'Subject',
		placeholderEmail: 'name@email.com',
		placeholderPhone: 'E.g. +1234567890',
		placeholderComment: 'Leave a comment',
		errorInvalid: 'Please enter a valid email or a valid phone number.',
		errorRequired: 'The Comment field is required.',
		errorDisposable: 'Disposable email addresses are not accepted.',
		errorHoneypot: 'Automated submission detected (honeypot).',
		errorTooFast: 'Form submitted too quickly; please wait a few seconds.',
		errorSpam: 'The message looks like spam or gibberish. Please write a clear comment.',
		errorRateLimit: 'You have sent too many messages. Try again later.',
		send: 'Send',
		sending: 'Sending...',
		sent: 'Sent'
	}
};

function applyTranslations() {
	const root = document.documentElement;
	const lang = root.dataset.lang || 'es';
	const map = T[lang] || T.es;
	document.querySelectorAll('[data-i18n]').forEach(el => {
		const key = el.getAttribute('data-i18n');
		if (key && map[key]) el.textContent = map[key];
	});
	document.querySelectorAll('[data-placeholder-key]').forEach(inp => {
		const key = inp.getAttribute('data-placeholder-key');
		if (key && map[key]) inp.placeholder = map[key];
	});
	const btn = document.getElementById('button');
	if (btn) btn.value = (map.send || 'Enviar');
	const err = document.getElementById('form-error');
	if (err) { err.classList.add('hidden'); err.textContent = '' }
}

applyTranslations();
const root = document.documentElement;
const obs = new MutationObserver(() => applyTranslations());
obs.observe(root, { attributes: true, attributeFilter: ['data-lang'] });

// ----- Anti-spam / validation helpers -----
const MIN_MESSAGE_LENGTH = 20; // caracteres
const MIN_WORDS = 3;
const MIN_SECONDS_BEFORE_SUBMIT = 4; // evitar envíos robóticos instantáneos
const RATE_LIMIT_MAX = 5; // envíos
const RATE_LIMIT_WINDOW_MS = 60 * 60 * 1000; // 1 hora
const SENDS_STORAGE_KEY = 'contact_sends_v1';

// lista pequeña de dominios desechables comunes (puedes ampliarla)
const DISPOSABLE_DOMAINS = [
	'mailinator.com','10minutemail.com','yopmail.com','temp-mail.org','maildrop.cc','guerrillamail.com','trashmail.com','dispostable.com','mailnesia.com','tempmail.com','getnada.com'
];

function isDisposableEmail(email) {
	try {
		const domain = email.split('@')[1].toLowerCase();
		return DISPOSABLE_DOMAINS.some(d => domain === d || domain.endsWith('.' + d));
	} catch (e) { return false; }
}

function alphaRatio(text) {
	const letters = (text.match(/[A-Za-zÀ-ÖØ-öø-ÿ]/g) || []).length;
	const total = text.length || 1;
	return letters / total;
}

function hasLongRepeats(text, n = 8) {
	return /(.)\1{7,}/.test(text); // same char repeated >7 times
}

function isLowQualityMessage(msg) {
	if (!msg) return true;
	if (msg.length < MIN_MESSAGE_LENGTH) return true;
	const words = msg.trim().split(/\s+/).filter(Boolean).length;
	if (words < MIN_WORDS) return true;
	if (alphaRatio(msg) < 0.5) return true; // too many non-letters
	if (hasLongRepeats(msg)) return true;
	// detect long sequences of random letters (e.g. 15+ letters no spaces)
	if (/[A-Za-z]{15,}/.test(msg.replace(/\s+/g, ''))) return true;
	return false;
}

function getSendTimestamps() {
	try {
		const raw = localStorage.getItem(SENDS_STORAGE_KEY);
		return raw ? JSON.parse(raw) : [];
	} catch (e) { return []; }
}

function cleanOldSends(list) {
	const cutoff = Date.now() - RATE_LIMIT_WINDOW_MS;
	return list.filter(ts => ts >= cutoff);
}

function recordSendAttempt() {
	const list = cleanOldSends(getSendTimestamps());
	list.push(Date.now());
	localStorage.setItem(SENDS_STORAGE_KEY, JSON.stringify(list));
}

function tooManySends() {
	const list = cleanOldSends(getSendTimestamps());
	return list.length >= RATE_LIMIT_MAX;
}

function setFieldError(id, hasError) {
	const field = document.getElementById(id);
	if (!field) return;
	if (hasError) {
		field.classList.add('border-red-500');
		field.setAttribute('aria-invalid', 'true');
	} else {
		field.classList.remove('border-red-500');
		field.removeAttribute('aria-invalid');
	}
}

// set initial form timestamp on load
window.addEventListener('DOMContentLoaded', () => {
	const ts = document.getElementById('form_timestamp');
	if (ts) ts.value = String(Date.now());
});

function showError(key) {
	const lang = document.documentElement.dataset.lang || 'es';
	const map = T[lang] || T.es;
	const errorDiv = document.getElementById('form-error');
	if (!errorDiv) return;
	errorDiv.classList.remove('hidden');
	errorDiv.textContent = map[key] || map.errorRequired || 'Error';
}

function validateForm(event) {
	event.preventDefault();
	const email = (document.getElementById('email') || {}).value || '';
	const telefono = (document.getElementById('telefono') || {}).value || '';
	const coments = (document.getElementById('coments') || {}).value || '';
	const honeypot = (document.getElementById('hp_name') || {}).value || '';
	const tsField = document.getElementById('form_timestamp');
	const btn = document.getElementById('button');

	const lang = document.documentElement.dataset.lang || 'es';
	const map = T[lang] || T.es;

	// basic contact checks
	const emailValid = email && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
	const telValid = telefono && /^\+?\d{8,15}$/.test(telefono);

	// honeypot
	if (honeypot && honeypot.trim() !== '') {
		setFieldError('hp_name', true);
		showError('errorHoneypot');
		return false;
	}

	// timestamp (avoid instant submits)
	if (tsField && tsField.value) {
		const delta = Date.now() - parseInt(tsField.value, 10);
		if (delta < (MIN_SECONDS_BEFORE_SUBMIT * 1000)) {
			showError('errorTooFast');
			return false;
		}
	}

	// rate limit per client
	if (tooManySends()) {
		showError('errorRateLimit');
		return false;
	}

	// contact method validation
	setFieldError('email', !emailValid && !telValid);
	setFieldError('telefono', !telValid && !emailValid);

	if (!(emailValid || telValid)) {
		showError('errorInvalid');
		return false;
	}

	// disposable domains
	if (emailValid && isDisposableEmail(email)) {
		showError('errorDisposable');
		return false;
	}

	// message quality
	if (!coments || isLowQualityMessage(coments)) {
		setFieldError('coments', true);
		showError('errorSpam');
		return false;
	}

	// passed front-end checks — prepare UI and record attempt
	const errorDiv = document.getElementById('form-error'); if (errorDiv) { errorDiv.classList.add('hidden'); errorDiv.textContent = ''; }
	if (btn) {
		btn.disabled = true;
		const mapLabel = map.sending || 'Sending...';
		btn.value = mapLabel;
		btn.insertAdjacentHTML('beforeend', '<span id="spinner" class="ml-2 animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full"></span>');
	}

	// record attempt now (defence-in-depth). If send fails you could remove the timestamp later.
	recordSendAttempt();

	// Call existing EmailJS wrapper
	if (typeof window.sendEmail === 'function') {
		window.sendEmail(event.target, btn);
	} else {
		console.warn('sendEmail not defined');
		if (btn) { btn.disabled = false; btn.value = map.send; const spinner = document.getElementById('spinner'); if (spinner) spinner.remove(); }
		showError('errorRequired');
	}

	return false;
}

// on success the EmailJs wrapper should dispatch a 'messageSent' event — we already had logic to reset; keep it and also clear errors
window.addEventListener('messageSent', function() {
	const form = document.getElementById('form');
	if (form) form.reset();
	const btn = document.getElementById('button');
	const lang = document.documentElement.dataset.lang || 'es';
	const map = T[lang] || T.es;
	if (btn) {
		btn.disabled = false;
		btn.value = map.send;
	}
	const spinner = document.getElementById('spinner');
	if (spinner) spinner.remove();
	setFieldError('email', false);
	setFieldError('telefono', false);
	setFieldError('coments', false);
	const err = document.getElementById('form-error'); if (err) { err.classList.add('hidden'); err.textContent = ''; }
});

</script>
